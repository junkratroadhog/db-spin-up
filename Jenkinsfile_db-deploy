pipeline {
    agent any

    parameters {
        string(
            name: 'CONFIG',
            // Set to 'true' to retain the DB container after the pipeline completes
            defaultValue: 'ORACLE_IMAGE=gvenzl/oracle-xe:21-slim,ORACLE_CNAME=usersdb,ORACLE_PORT=1525,RETAIN_DB=true,ORACLE_SID=XE,ORACLE_PDB=XEPDB1',  // default if not passed
            description: 'Comma-separated key=value pairs to override default environment variables. Supported keys: ORACLE_IMAGE, ORACLE_CNAME, ORACLE_PASSWORD, ORACLE_PORT, RETAIN_DB'
        )
    }

    environment {
        // ORACLE_IMAGE = 'gvenzl/oracle-xe'   //DEFAULT
        // ORACLE_CNAME = 'oracle-db'          //DEFAULT
        ORACLE_PASSWORD = 'oracle'          //DEFAULT
        // ORACLE_PORT = 1521                  //DEFAULT
        // RETAIN_DB = 'false'  //DEFAULT Set to 'true' to retain the DB container after the pipeline completes
        // ORACLE_SID   = 'XE'
        // ORACLE_PDB   = 'XEPDB1'
    }

    stages {

        stage('Debug CONFIG') {
            steps {
                echo "CONFIG received: '${params.CONFIG}'"
            }
        }

        stage('Parse CONFIG') {
            steps {
                script {
                    if (params.CONFIG?.trim()) {
                        params.CONFIG.split(',').each { kv ->
                            if (kv.contains('=')) {
                                def (k, v) = kv.split('=', 2)
                                env."${k.trim()}" = v.trim()
                            }
                        }
                    }
                    echo """
                    ORACLE_CNAME=${env.ORACLE_CNAME}
                    ORACLE_PORT=${env.ORACLE_PORT}
                    ORACLE_SID=${env.ORACLE_SID}
                    ORACLE_PDB=${env.ORACLE_PDB}
                    ORACLE_IMAGE=${env.ORACLE_IMAGE}
                    RETAIN_DB=${env.RETAIN_DB}
                    """
                }
            }
        }

        stage('Scripts List and Permission check') {
            steps{
                sh 'chmod +x scripts/deploy/*.sh'
            }
        }

        stage('Oracle Container Registry Login') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'OCR_CRED', 
                                                  usernameVariable: 'ORACLE_USER', 
                                                  passwordVariable: 'ORACLE_AUTH')])
                sh '''
                echo "\$ORACLE_AUTH" | docker login container-registry.oracle.com \
                            -u $ORACLE_USER --password-stdin
                '''
            }
        }

        stage("Creating Oracle DB in Docker Container") {
            steps {
                sh '''
                ./scripts/deploy/deploy_create_oracle_container.sh
                '''
            }
        }

        stage('Validating Oracle DB in Container') {
            steps {
                    sh '''
                    ./scripts/deploy/deploy_validate_oracle_container.sh
                    '''
            } 
        }

        stage('Validation of DB & Listener Status'){
            steps{
                sh '''
                    ./scripts/deploy/deploy_final_validate.sh
                '''
            }
        }
    }

    post {
        always {
            sh ''' 
                echo "Cleaning up..."
                if [ "${RETAIN_DB}" != "true" ]; then
                    docker stop ${ORACLE_CNAME}
                    docker rm ${ORACLE_CNAME}
                fi
            '''
        }
    }      
}